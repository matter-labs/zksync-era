name: Workflow for testing prover component end-to-end
on:
  workflow_call:

jobs:
  e2e-test:
    runs-on: [ matterlabs-ci-gpu-l4-runner-prover-tests ]
    env:
      RUNNER_COMPOSE_FILE: "docker-compose-gpu-runner-cuda-12-0.yml"

    steps:
      - uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4
        with:
          submodules: "recursive"
          fetch-depth: 0

      - name: Setup environment
        run: |
          echo ZKSYNC_HOME=$(pwd) >> $GITHUB_ENV
          echo $(pwd)/bin >> $GITHUB_PATH
          echo IN_DOCKER=1 >> .env
          echo "SCCACHE_GCS_BUCKET=matterlabs-infra-sccache-storage" >> .env
          echo "SCCACHE_GCS_SERVICE_ACCOUNT=gha-ci-runners@matterlabs-infra.iam.gserviceaccount.com" >> .env
          echo "SCCACHE_GCS_RW_MODE=READ_WRITE" >> .env
          echo "RUSTC_WRAPPER=sccache" >> .env
          
          mkdir -p prover_logs

      - name: Start services
        run: |
          run_retried docker-compose -f ${RUNNER_COMPOSE_FILE} pull
          mkdir -p ./volumes/postgres ./volumes/reth/data
          docker-compose -f ${RUNNER_COMPOSE_FILE} --profile runner up -d --wait
          ci_run sccache --start-server

      - name: Init
        run: |
          ci_run git config --global --add safe.directory /usr/src/zksync
          ci_run git config --global --add safe.directory /usr/src/zksync/sdk/binaryen
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/system-contracts
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/forge-std
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/murky
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/murky/lib/forge-std
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/murky/lib/openzeppelin-contracts
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/murky/lib/openzeppelin-contracts/lib/erc4626-tests
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/murky/lib/openzeppelin-contracts/lib/forge-std
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/murky/lib/openzeppelin-contracts/lib/forge-std/lib/ds-test
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/openzeppelin-contracts
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/openzeppelin-contracts/lib/forge-std
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/openzeppelin-contracts/lib/forge-std/lib/ds-test
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/openzeppelin-contracts/lib/erc4626-tests
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/openzeppelin-contracts-upgradeable
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/openzeppelin-contracts-upgradeable/lib/erc4626-tests
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/openzeppelin-contracts-upgradeable/lib/forge-std
          ci_run git config --global --add safe.directory /usr/src/zksync/contracts/l1-contracts/lib/openzeppelin-contracts-upgradeable/lib/forge-std/lib/ds-test
          
          ci_run ./bin/zkt
          ci_run zk_inception chain create \
            --chain-name provers \
            --chain-id sequential \
            --prover-mode gpu \
            --wallet-creation localhost \
            --l1-batch-commit-data-generator-mode rollup \
            --base-token-address 0x0000000000000000000000000000000000000001 \
            --base-token-price-nominator 1 \
            --base-token-price-denominator 1 \
            --set-as-default true \
            --ignore-prerequisites 

          ci_run zk_inception ecosystem init --dev --verbose
          ci_run zk_inception prover init --dev --verbose
          
          echo "URL=$(grep "http_url" ./chains/provers/configs/general.yaml | awk '{ print $2 }')" >> $GITHUB_ENV
      - name: Build prover binaries
        run: |
          ci_run cargo build --release --workspace --manifest-path=prover/Cargo.toml
      - name: Prepare prover subsystem
        run: |
          ci_run zk_inception prover init-bellman-cuda --clone --verbose
          ci_run zk_inception prover setup-keys --mode=download --region=us --verbose
      - name: Run server
        run: |
          ci_run zk_inception server --uring --chain=provers --components=api,tree,eth,state_keeper,commitment_generator,proof_data_handler,vm_runner_protective_reads,vm_runner_bwip &>prover_logs/server.log &
      - name: Run Gateway
        run: |
          ci_run zk_inception prover run --component=gateway --docker=false &>prover_logs/gateway.log &
      - name: Run Prover Job Monitor
        run: |
          ci_run zk_inception prover run --component=prover-job-monitor --docker=false &>prover_logs/prover-job-monitor.log &
      - name: Wait for batch to be available
        env:
          DATABASE_URL: postgres://postgres:notsecurepassword@localhost:5432/zksync_prover_localhost_provers
          BATCH_NUMBER: 1
          INTERVAL: 30
          TIMEOUT: 300
        run: |
          ci_run chmod +x ./bin/prover_checkers/batch_availability_checker
          
          PASSED_ENV_VARS="DATABASE_URL,BATCH_NUMBER,INTERVAL,TIMEOUT" \
          ci_run ./bin/prover_checkers/batch_availability_checker
      - name: Run Witness Generator
        run: |
          ci_run zk_inception prover run --component=witness-generator --round=all-rounds --docker=false &>prover_logs/witness-generator.log &
      - name: Run Circuit Prover
        run: |
          ci_run zk_inception prover run --component=circuit-prover --witness-vector-generator-count=10 --docker=false &>prover_logs/circuit_prover.log &
          ci_run sleep 1200
      - name: Wait for prover jobs to finish
        env:
          DATABASE_URL: postgres://postgres:notsecurepassword@localhost:5432/zksync_prover_localhost_provers
          BATCH_NUMBER: 1
          INTERVAL: 30
          TIMEOUT: 1800
        run: |
          ci_run chmod +x ./bin/prover_checkers/prover_jobs_status_checker
          
          PASSED_ENV_VARS="DATABASE_URL,BATCH_NUMBER,INTERVAL,TIMEOUT" \
          ci_run ./bin/prover_checkers/prover_jobs_status_checker

      - name: Kill prover & start compressor
        run: |
          
          chmod +x ./bin/prover_checkers/kill_prover
          sudo ./bin/prover_checkers/kill_prover
          
          ci_run zk_inception prover run --component=compressor --docker=false &>prover_logs/compressor.log &
      - name: Wait for batch to be executed on L1
        env:
            DATABASE_URL: postgres://postgres:notsecurepassword@localhost:5432/zksync_prover_localhost_provers
            BATCH_NUMBER: 1
            INTERVAL: 30
            TIMEOUT: 600
        run: |
          ci_run chmod +x ./bin/prover_checkers/batch_l1_status_checker
          
          PASSED_ENV_VARS="BATCH_NUMBER,DATABASE_URL,URL,INTERVAL,TIMEOUT" \
          ci_run ./bin/prover_checkers/batch_l1_status_checker

      - name: Upload logs
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        if: always()
        with:
          name: prover_logs
          path: prover_logs
