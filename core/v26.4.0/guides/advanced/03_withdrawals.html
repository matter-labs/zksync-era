<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Withdrawals - ZKsync Era Documentation</title>


        <!-- Custom HTML head -->
        <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../css/version-box.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync Era Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs/src/guides/advanced/03_withdrawals.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="zksync-deeper-dive-bridging-stuff-back-aka-withdrawals"><a class="header" href="#zksync-deeper-dive-bridging-stuff-back-aka-withdrawals">ZKsync deeper dive bridging stuff back (a.k.a withdrawals)</a></h1>
<p>Assuming that you have completed <a href="01_initialization.html">part 1</a> and <a href="02_deposits.html">part 2</a> already, we can bridge the
tokens back by simply calling the zksync-cli:</p>
<pre><code class="language-bash">npx zksync-cli bridge withdraw --chain=dockerized-node
</code></pre>
<p>And providing the account name (public address) and private key.</p>
<p>Afterward, by using <code>web3</code> tools, we can quickly check that funds were transferred back to L1. <strong>And you discover that
they didnâ€™t</strong> - what happened?</p>
<p>Actually weâ€™ll have to run one additional step:</p>
<pre><code class="language-bash">npx zksync-cli bridge withdraw-finalize --chain=dockerized-node
</code></pre>
<p>and pass the transaction that we received from the first call, into the <code>withdraw-finalize</code> call.</p>
<p><strong>Note:</strong> This is not needed on testnet - as we (MatterLabs) - are running an automatic tool that confirms withdrawals.</p>
<h3 id="looking-deeper"><a class="header" href="#looking-deeper">Looking deeper</a></h3>
<p>But letâ€™s take a look what happened under the hood.</p>
<p>Letâ€™s start by looking at the output of our <code>zksync-cli</code>:</p>
<pre><code>Withdrawing 7ETH to 0x618263CE921F7dd5F4f40C29f6c524Aaf97b9bbd on localnet
Transaction submitted ðŸ’¸ðŸ’¸ðŸ’¸
L2: tx/0xe2c8a7beaf8879cb197555592c6eb4b6e4c39a772c3b54d1b93da14e419f4683
Your funds will be available in L1 in a couple of minutes.
</code></pre>
<p><strong>important</strong> - your transaction id will be different - make sure that you use it in the methods below.</p>
<p>The tool created the withdraw transaction and it sent it directly to our server (so this is a L2 transaction). The zk
server has received it, and added it into its database. You can check it by querying the <code>transactions</code> table:</p>
<pre><code class="language-shell"># select * from transactions where hash = '\x&lt;YOUR_L2_TRANSACTION_ID_FROM_ABOVE&gt;`
select * from transactions where hash = '\xe2c8a7beaf8879cb197555592c6eb4b6e4c39a772c3b54d1b93da14e419f4683';
</code></pre>
<p>This will print a lot of columns, but letâ€™s start by looking at the <code>data</code> column:</p>
<pre><code class="language-json">{
  "value": "0x6124fee993bc0000",
  "calldata": "0x51cff8d9000000000000000000000000618263ce921f7dd5f4f40c29f6c524aaf97b9bbd",
  "factoryDeps": null,
  "contractAddress": "0x000000000000000000000000000000000000800a"
}
</code></pre>
<p>We can use the ABI decoder tool <a href="https://calldata-decoder.apoorv.xyz/">https://calldata-decoder.apoorv.xyz/</a> to see what this call data means:</p>
<pre><code class="language-json">{
  "function": "withdraw(address)",
  "params": ["0x618263CE921F7dd5F4f40C29f6c524Aaf97b9bbd"]
}
</code></pre>
<p>(and the 0x6124fee993bc0000 in the value is 7000000000000000000 == 7 ETH that we wanted to send).</p>
<p>So the last question is â€“ what is the â€˜magicâ€™ contract address: <code>0x800a</code> ?</p>
<pre><code class="language-solidity">/// @dev The address of the eth token system contract
address constant L2_BASE_TOKEN_SYSTEM_CONTRACT_ADDR = address(0x800a);

</code></pre>
<h3 id="system-contracts-on-l2"><a class="header" href="#system-contracts-on-l2">System contracts (on L2)</a></h3>
<p>This is a good opportunity to talk about system contracts that are automatically deployed on L2. You can find the full
list here
<a href="https://github.com/matter-labs/era-system-contracts/blob/436d57da2fb35c40e38bcb6637c3a090ddf60701/scripts/constants.ts#L29">in github</a></p>
<p>This is the place where we specify that <code>bootloader</code> is at address 0x8001, <code>NonceHolder</code> at 0x8003 etc.</p>
<p>This brings us to
<a href="https://github.com/matter-labs/era-system-contracts/blob/main/contracts/L2EthToken.sol">L2BaseToken.sol</a> that has the
implementation of the L2 Eth.</p>
<p>When we look inside, we can see:</p>
<pre><code class="language-solidity">// Send the L2 log, a user could use it as proof of the withdrawal
bytes memory message = _getL1WithdrawMessage(_l1Receiver, amount);
L1_MESSENGER_CONTRACT.sendToL1(message);
</code></pre>
<p>And <code>L1MessengerContract</code> (that is deployed at 0x8008).</p>
<h3 id="committing-to-l1"><a class="header" href="#committing-to-l1">Committing to L1</a></h3>
<p>And how do these messages get into the L1? The <code>eth_sender</code> class from our server is taking care of this. You can see
the details of the transactions that it posts to L1 in our database in <code>eth_txs</code> table.</p>
<p>If you look at the <code>tx_type</code> column (in psql), you can see that we have 3 different transaction types:</p>
<pre><code class="language-sql">zksync_local=# select contract_address, tx_type from eth_txs;
              contract_address              |          tx_type
--------------------------------------------+---------------------------
 0x54e8159f006750466084913d5bd288d4afb1ee9a | CommitBlocks
 0x54e8159f006750466084913d5bd288d4afb1ee9a | PublishProofBlocksOnchain
 0x54e8159f006750466084913d5bd288d4afb1ee9a | ExecuteBlocks
 0x54e8159f006750466084913d5bd288d4afb1ee9a | CommitBlocks
 0x54e8159f006750466084913d5bd288d4afb1ee9a | PublishProofBlocksOnchain
 0x54e8159f006750466084913d5bd288d4afb1ee9a | ExecuteBlocks
</code></pre>
<p>BTW - all the transactions are sent to the 0x54e address - which is the <code>DiamondProxy</code> deployed on L1 (this address will
be different on your local node - see previous tutorial for more info) .</p>
<p>And inside, all three methods above belong to
<a href="https://github.com/matter-labs/era-contracts/blob/dev/l1-contracts/contracts/state-transition/chain-deps/facets/Executor.sol">Executor.sol</a>
facet and you can look at
<a href="https://github.com/matter-labs/era-contracts/blob/main/docs/Overview.md#executorfacet">README</a> to see the details of
what each method does.</p>
<p>The short description is:</p>
<ul>
<li>â€˜CommitBlocksâ€™ - is verifying the block metadata and stores the hash into the L1 contract storage.</li>
<li>â€˜PublishProofâ€™ - gets the proof, checks that the proof is correct and that it is a proof for the block hash that was
stored in commit blocks. (IMPORTANT: in testnet/localnet we allow empty proofs - so that you donâ€™t have to run the
full prover locally)</li>
<li>â€˜ExecuteBlocksâ€™ - is the final call, that stores the root hashes in L1 storage. This allows other calls (like
finalizeWithdrawal) to work.</li>
</ul>
<p>So to sum it up - after these 3 calls, the L1 contract has a root hash of a merkle tree, that contains the â€˜messageâ€™
about the withdrawal.</p>
<h3 id="final-step---finalizing-withdrawal"><a class="header" href="#final-step---finalizing-withdrawal">Final step - finalizing withdrawal</a></h3>
<p>Now weâ€™re ready to actually claim our ETH on L1. We do this by calling a <code>finalizeEthWithdrawal</code> function on the
DiamondProxy contract (Mailbox.sol to be exact).</p>
<p>To prove that we actually can withdraw the money, we have to say in which L2 block the withdrawal happened, and provide
the merkle proof from our withdrawal log, to the root that is stored in the L1 contract.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../guides/advanced/02_deposits.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../guides/advanced/04_contracts.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../guides/advanced/02_deposits.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../guides/advanced/04_contracts.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../js/version-box.js"></script>
        <script src="../../js/mermaid-init.js"></script>


    </div>
    </body>
</html>
