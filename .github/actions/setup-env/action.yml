name: Setup Environment

inputs:
  runner-compose-file:
    description: 'Path to the runner compose file'
    default: 'docker-compose.yml'

runs:
  using: composite
  steps:

    - name: Setup misc environment variables
      shell: bash
      run: |
        echo $(pwd)/bin >> $GITHUB_PATH
        echo $HOME/.local/bin >> $GITHUB_PATH
        echo ZKSYNC_HOME=$(pwd) >> $GITHUB_ENV
        echo CI=1 >> $GITHUB_ENV
        echo IN_DOCKER=1 >> .env
        echo CI=1 >> .env
        echo RUNNER_COMPOSE_FILE=${{ inputs.runner-compose-file }} >> $GITHUB_ENV

    - name: Setup sccache for building rust code outside Docker
      shell: bash
      run: |
        # sccache binary is not available on arm64 instances
        if [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "arm64" ]; then
          echo SCCACHE_CACHE_SIZE=50G >> $GITHUB_ENV
          echo SCCACHE_GCS_BUCKET=matterlabs-infra-sccache-storage >> $GITHUB_ENV
          echo SCCACHE_GCS_SERVICE_ACCOUNT=gha-ci-runners@matterlabs-infra.iam.gserviceaccount.com >> $GITHUB_ENV
          echo SCCACHE_ERROR_LOG=/tmp/sccache_log.txt >> $GITHUB_ENV
          echo SCCACHE_GCS_RW_MODE=READ_WRITE >> $GITHUB_ENV
          echo RUSTC_WRAPPER=sccache >> $GITHUB_ENV

          # sccache outside docker will run it's own server
          echo SCCACHE_SERVER_PORT=4225 >> $GITHUB_ENV
        fi

    - name: Setup sccache for building rust code inside Docker
      shell: bash
      run: |
        echo SCCACHE_CACHE_SIZE=50G >> .env
        echo SCCACHE_GCS_BUCKET=matterlabs-infra-sccache-storage >> .env
        echo SCCACHE_GCS_SERVICE_ACCOUNT=gha-ci-runners@matterlabs-infra.iam.gserviceaccount.com >> .env
        echo SCCACHE_ERROR_LOG=/tmp/sccache_log.txt >> .env
        echo SCCACHE_GCS_RW_MODE=READ_WRITE >> .env
        echo RUSTC_WRAPPER=sccache >> .env
        echo DOCKER_PWD=$(pwd) >> .env

    - name: Start localnet
      shell: bash
      run: |
        mkdir -p ./hardhat-nodejs
        ci_localnet_up

    - name: Start sccache servers
      shell: bash
      run: |
        ci_run sccache --start-server
        # sccache binary is not available on arm64 instances
        if [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "arm64" ]; then
          sccache --start-server
        fi

    - name: Init git safe directories
      shell: bash
      run: |
        ci_run git config --global --add safe.directory /usr/src/zksync
        ci_run git config --global --add safe.directory /usr/src/zksync/sdk/binaryen
        ci_run git config --global --add safe.directory /usr/src/zksync/contracts/system-contracts
        ci_run git config --global --add safe.directory /usr/src/zksync/contracts
