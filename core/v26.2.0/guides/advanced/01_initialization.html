<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Local initialization - ZKsync Era Documentation</title>


        <!-- Custom HTML head -->
        <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../css/version-box.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync Era Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs/src/guides/advanced/01_initialization.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="zksync-deeper-dive"><a class="header" href="#zksync-deeper-dive">ZKsync Deeper Dive</a></h1>
<p>The goal of this doc is to show you some more details on how ZKsync works internally.</p>
<p>Please do the dev_setup.md and development.md (these commands do all the heavy lifting on starting the components of the
system).</p>
<p>Now let’s take a look at what’s inside:</p>
<h3 id="initialization"><a class="header" href="#initialization">Initialization</a></h3>
<p>Let’s take a deeper look into what <code>zkstack ecosystem init</code> does.</p>
<h4 id="zk-stack-cli"><a class="header" href="#zk-stack-cli">ZK Stack CLI</a></h4>
<p><code>zkstack</code> itself is implemented in Rust (you can see the code in <code>/zkstack_cli</code> directory). If you change anything
there, make sure to run <code>zkstackup --local</code> from the root folder (that compiles and installs this code), before
re-running any <code>zkstack</code> command.</p>
<h4 id="containers"><a class="header" href="#containers">Containers</a></h4>
<p>The first step to initialize a ZK Stack ecosystem is to run the command <code>zkstack containers</code>. This command gets the
docker images for <code>postgres</code> and <code>reth</code>. If the <code>--observability</code> option is passed to the command, or the corresponding
option is selected in the interactive prompt, then Prometheus, Grafana and other observability-related images are
downloaded and run.</p>
<p>Reth (one of the Ethereum clients) will be used to setup our own copy of L1 chain (that our local ZKsync would use).</p>
<p>Postgres is one of the two databases, that is used by ZKsync (the other one is RocksDB). Currently most of the data is
stored in postgres (blocks, transactions etc) - while RocksDB is only storing the state (Tree &amp; Map) - and it used by
VM.</p>
<h4 id="ecosystem"><a class="header" href="#ecosystem">Ecosystem</a></h4>
<p>The next step is to run the command <code>zkstack ecosystem init</code>.</p>
<p>This command:</p>
<ul>
<li>Collects and finalize the ecosystem configuration.</li>
<li>Builds and deploys L1 &amp; L2 contracts.</li>
<li>Initializes each chain defined in the <code>/chains</code> folder. (Currently, a single chain <code>era</code> is defined there, but you can
create your own chains running <code>zkstack chain create</code>).</li>
<li>Sets up observability.</li>
<li>Runs the genesis process.</li>
<li>Initializes the database.</li>
</ul>
<h4 id="postgres"><a class="header" href="#postgres">Postgres</a></h4>
<p>First - postgres database: you’ll be able to see something like</p>
<pre><code>DATABASE_URL = postgres://postgres:notsecurepassword@localhost/zksync_local
</code></pre>
<p>After which we setup the schema (lots of lines with <code>Applied XX</code>).</p>
<p>You can try connecting to postgres now, to see what’s inside:</p>
<pre><code class="language-shell">psql postgres://postgres:notsecurepassword@localhost/zksync_local
</code></pre>
<p>(and then commands like <code>\dt</code> to see the tables, <code>\d TABLE_NAME</code> to see the schema, and <code>select * from XX</code> to see the
contents).</p>
<p>As our network has just started, the database would be quite empty.</p>
<p>You can see the schema for the database in <a href="../../../core/lib/dal/README.html">dal/README.md</a> TODO: add the link to the
document with DB schema.</p>
<h4 id="docker"><a class="header" href="#docker">Docker</a></h4>
<p>We’re running two things in a docker:</p>
<ul>
<li>a postgres (that we’ve covered above)</li>
<li>a reth (that is the L1 Ethereum chain).</li>
</ul>
<p>Let’s see if they are running:</p>
<pre><code class="language-shell">docker container ls
</code></pre>
<p>and then we can look at the Reth logs:</p>
<pre><code class="language-shell">docker logs zksync-era-reth-1
</code></pre>
<p>Where <code>zksync-era-reth-1</code> is the container name, that we got from the first command.</p>
<p>If everything goes well, you should see that L1 blocks are being produced.</p>
<h4 id="server"><a class="header" href="#server">Server</a></h4>
<p>Now we can start the main server:</p>
<pre><code class="language-bash">zkstack server
</code></pre>
<p>This will actually run a cargo binary (<code>zksync_server</code>).</p>
<p>The server will wait for the new transactions to generate the blocks (these can either be sent via JSON RPC, but it also
listens on the logs from the L1 contract - as things like token bridging etc comes from there).</p>
<p>Currently we don’t send any transactions there (so the logs might be empty).</p>
<p>But you should see some initial blocks in postgres:</p>
<pre><code class="language-sql">select * from miniblocks;
</code></pre>
<h4 id="our-l1-reth"><a class="header" href="#our-l1-reth">Our L1 (reth)</a></h4>
<p>Let’s finish this article, by taking a look at our L1:</p>
<p>We will use the <code>web3</code> tool to communicate with the L1, have a look at <a href="02_deposits.html">02_deposits.md</a> for installation
instructions. You can check that you’re a (localnet) crypto trillionaire, by running:</p>
<pre><code class="language-bash">./web3 --rpc-url http://localhost:8545 balance 0x36615Cf349d7F6344891B1e7CA7C72883F5dc049
</code></pre>
<p>This is one of the “rich wallets” we predefined for local L1.</p>
<p><strong>Note:</strong> This reth shell is running official Ethereum JSON RPC with Reth-specific extensions documented at
<a href="https://paradigmxyz.github.io/reth/jsonrpc/intro.html">reth docs</a></p>
<p>In order to communicate with L2 (our ZKsync) - we have to deploy multiple contracts onto L1 (our local reth created
Ethereum). You can look on the <code>deployL1.log</code> file - to see the list of contracts that were deployed and their accounts.</p>
<p>First thing in the file, is the deployer/governor wallet - this is the account that can change, freeze and unfreeze the
contracts (basically the owner). You can verify the token balance using the <code>getBalance</code> method above.</p>
<p>Then, there are a bunch of contracts (CRATE2_FACTOR, DIAMOND_PROXY, L1_ALLOW_LIST etc etc) - for each one, the file
contains the address.</p>
<p>You can quickly verify that they were really deployed, by calling:</p>
<pre><code class="language-bash">./web3 --rpc-url http://localhost:8545 address XXX
</code></pre>
<p>Where XXX is the address in the file.</p>
<p>The most important one of them is CONTRACTS_DIAMOND_PROXY_ADDR (which acts as ‘loadbalancer/router’ for others - and
this is the contract that our server is ‘listening’ on).</p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Ok - so let’s sum up what we have:</p>
<ul>
<li>a postgres running in docker (main database)</li>
<li>a local instance of ethereum (reth running in docker)
<ul>
<li>which also has a bunch of ‘magic’ contracts deployed</li>
<li>and two accounts with lots of tokens</li>
</ul>
</li>
<li>and a server process</li>
</ul>
<p>In the <a href="02_deposits.html">next article</a>, we’ll start playing with the system (bridging tokens etc).</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../guides/advanced/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../guides/advanced/02_deposits.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../guides/advanced/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../guides/advanced/02_deposits.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../js/version-box.js"></script>
        <script src="../../js/mermaid-init.js"></script>


    </div>
    </body>
</html>
