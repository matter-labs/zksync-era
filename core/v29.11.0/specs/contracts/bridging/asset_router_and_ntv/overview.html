<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Asset Router and NTV - ZKsync Era Documentation</title>


        <!-- Custom HTML head -->
        <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../../css/version-box.css">
        <link rel="stylesheet" href="../../../.././css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync Era Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs/src/specs/contracts/bridging/asset_router_and_ntv/overview.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overview-of-custom-asset-bridging-with-the-asset-router"><a class="header" href="#overview-of-custom-asset-bridging-with-the-asset-router">Overview of Custom Asset Bridging with the Asset Router</a></h1>
<p>Bridges are completely separate contracts from the ZKChains and system contracts. They are a wrapper for L1 &lt;-&gt; L2 communication on both L1 and L2. Upon locking assets on one layer, a request is sent to mint these bridged assets on the other layer.
Upon burning assets on one layer, a request is sent to unlock them on the other.</p>
<p>Custom asset bridging is a new bridging model that allows to:</p>
<ol>
<li>Minimize the effort needed by custom tokens to be able to become part of the elastic chain ecosystem. Before, each custom token would have to build its own bridge, but now just custom asset deployment trackers / asset handler is needed. This is achieved by building a modular bridge which separates the logic of L1&lt;&gt;L2 messaging from the holding of the asset.</li>
<li>Unify the interfaces between L1 and L2 bridge contracts, paving the way for easy cross chain bridging. It will especially become valuable once interop is enabled.</li>
</ol>
<h4 id="new-concepts"><a class="header" href="#new-concepts">New concepts</a></h4>
<ul>
<li>assetId =&gt; identifier to track bridged assets across chains. This is used to link messages to specific asset handlers in the AssetRouters. Note, that since the same asset could be created on multiple chains, assetId is not just an address. It’s obtained by combining chain id, NTV as asset deployment tracker and asset data. Usually, address is used as asset data field. This was assets that share the same address on different chains will have different assetId.</li>
<li>AssetHandler =&gt; contract that manages liquidity (burns/mints, locks/unlocks, etc.) for specific token (or a set of them) on a chain.</li>
<li>AssetDeploymentTracker =&gt; contract that manages the deployment of asset handlers across chains. This is the contract that registers these asset handlers in the AssetRouters.</li>
<li>AssetRouter =&gt; contract that coordinates crosschain token bridging and routes messages to the correct AssetHandler.</li>
</ul>
<h3 id="normal-flow"><a class="header" href="#normal-flow">Normal flow</a></h3>
<h4 id="registering-a-custom-asset"><a class="header" href="#registering-a-custom-asset">Registering a custom asset</a></h4>
<ul>
<li>
<p>AssetHandler Registration for New Tokens
Before you can bridge a new token, you must register its AssetHandler in both routers. However, for NTV (Native Token Vault) assets this step isn’t required. If an L1→L2 transaction is submitted without a registered AssetHandler, it won’t fail—instead, the message is automatically forwarded to the L2NTV contract. The L2NTV then verifies that the asset was deployed by the L1NTV by checking that the <code>assetId</code> embeds the correct ADT address (for NTV assets, the ADT is the NTV and the relevant address is the L2NTV address). If the <code>assetId</code> is valid, the token contract is deployed on L2.</p>
</li>
<li>
<p>Automatic Bridging via the Native Token Vault
The Native Token Vault is a special AssetHandler designed for automatic bridging. It lets you bridge an L1 token to L2 without pre-deploying the token contract or registering it in the L2 router. Under the hood, unregistered AssetHandler messages are forwarded to the L2NTV, which performs the same <code>assetId</code> check and, upon validation, deploys the corresponding token contract.</p>
</li>
<li>
<p>Custom Asset Registration Flow</p>
<ol>
<li>Deploy the Asset Handlers (on L1 and L2), the custom token contracts, and the Asset Deployment Tracker (ADT). The ADT is expected to be deployed on L1.</li>
<li>The ADT calls <code>setAssetHandlerAddressThisChain</code> on <code>L1AssetRouter</code> to register itself and its corresponding Asset Handler by updating the appropriate mapping.</li>
<li>During an L1→L2 deposit, the internal method <code>_setAssetHandlerAddressOnCounterpart</code> is invoked automatically to propagate the registration to the L2 router.</li>
</ol>
<p>A visualization of this process can be seen here:<br />
<a href="./img/custom_asset_handler_registration.png">Asset Registration</a></p>
</li>
</ul>
<h4 id="bridging-an-already-registered-asset"><a class="header" href="#bridging-an-already-registered-asset">Bridging an already-registered asset</a></h4>
<ul>
<li>
<p>From L1 to L2</p>
<ol>
<li>The user calls <code>requestL2TransactionTwoBridges</code> on <code>Bridgehub</code>, specifying <code>L1AssetRouter</code> as the second bridge address, along with all other parameters required to initiate the transfer.</li>
<li>Under the hood, <code>Bridgehub</code>, <code>L1AssetRouter</code>, and the Asset Handler contracts verify the validity of the provided data, value, and allowances. If everything checks out, the <code>bridgehubRequestL2Transaction</code> method is called on the ZK Chain, appending a priority transaction to <code>L2AssetRouter.finalizeDeposit</code>.</li>
<li>The operator picks up the priority transaction. If it executes successfully, the transfer completes. Otherwise, the user can reclaim their assets via the <code>claimFailedDeposit</code> function in <code>L1AssetRouter</code>, providing proof that the transaction indeed failed on L2.</li>
</ol>
<p>A visualization of steps 1–2 can be seen here:<br />
<a href="./img/requestl2transactiontwobridges_token_deposit.png">RequestL2TransactionTwoBridges for token deposit</a>.</p>
</li>
<li>
<p>From L2 to L1</p>
<ol>
<li>The user calls <code>L2AssetRouter.withdraw(assetId, assetData)</code> directly. Here, <code>assetData</code> varies by Asset Handler; it’s parsed by the handler into the format it requires.</li>
<li>The L2 handler burns the tokens, and <code>L2AssetRouter</code> sends an L2→L1 message.</li>
<li>Once the L2→L1 message arrives on L1, the user calls <code>finalizeWithdrawal</code> on <code>L1AssetRouter</code>, providing the chain ID where the withdrawal was initiated, the message’s position in that chain, and proof of its inclusion. The <code>L1Nullifier</code> contract verifies the proof, and if it’s valid, control returns to <code>L1AssetRouter</code>, which then calls the appropriate Asset Handler (based on <code>assetId</code>) to release the assets.</li>
</ol>
</li>
</ul>
<h3 id="read-more"><a class="header" href="#read-more">Read more</a></h3>
<p>You can read more in the more in-depth about L1 and L2 asset routers and the default asset handler that is Native Token Vault <a href="./asset_router.html">here</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../specs/contracts/bridging/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../specs/contracts/bridging/asset_router_and_ntv/asset_router.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../specs/contracts/bridging/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../specs/contracts/bridging/asset_router_and_ntv/asset_router.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../../../ace.js"></script>
        <script src="../../../../editor.js"></script>
        <script src="../../../../mode-rust.js"></script>
        <script src="../../../../theme-dawn.js"></script>
        <script src="../../../../theme-tomorrow_night.js"></script>

        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../../js/version-box.js"></script>
        <script src="../../../../js/mermaid-init.js"></script>


    </div>
    </body>
</html>
