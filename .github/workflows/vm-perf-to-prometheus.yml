name: Push main branch VM benchmarks to Prometheus

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Disable simultaneous deployments into a single environment
concurrency: vm-benchmarks

jobs:
  vm-benchmarks:
    name: Run VM benchmarks
    runs-on: [matterlabs-ci-runner]

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: "recursive"

      - name: setup-env
        run: |
          echo PUSH_VM_BENCHMARKS_TO_PROMETHEUS=1 >> .env

          echo ZKSYNC_HOME=$(pwd) >> $GITHUB_ENV
          echo $(pwd)/bin >> $GITHUB_PATH

      - name: init
        run: |
          mkdir -p ./volumes/postgres
          mkdir -p ./volumes/geth/keystore
          mkdir -p ./volumes/prysm/beacon
          mkdir -p ./volumes/prysm/validator
          cp ./docker/prysm/config.yml ./volumes/prysm/config.yml
          cp ./docker/geth/jwtsecret ./volumes/geth/jwtsecret
          cp ./docker/geth/password.sec ./volumes/geth/password.sec
          cp ./docker/geth/keystore/UTC--2019-04-06T21-13-27.692266000Z--8a91dc2d28b689474298d91899f0c1baf62cb85b ./volumes/geth/keystore/
          docker-compose -f docker-compose-local-genesis.yml up
          docker-compose -f docker-compose-local-genesis.yml rm -f
          docker-compose --profile runner up -d --wait
          docker ps
          ci_run zk
          ci_run zk compiler system-contracts

      - name: run benchmarks
        run: |
          ci_run cargo bench --package vm-benchmark --bench diy_benchmark
          ci_run cargo bench --package vm-benchmark --bench iai | tee iai-result
          ci_run cargo run --package vm-benchmark --bin iai_results_to_prometheus --release < iai-result
