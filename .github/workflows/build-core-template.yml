name: Build Core images
on:
  workflow_call:
    secrets:
      DOCKERHUB_USER:
        description: "DOCKERHUB_USER"
        required: true
      DOCKERHUB_TOKEN:
        description: "DOCKERHUB_TOKEN"
        required: true
    inputs:
      image_tag_suffix:
        description: "Optional suffix to override tag name generation"
        type: string
        required: false
      action:
        description: "Action with docker image"
        type: string
        default: "push"
        required: false
jobs:
  create_manifest:
    name: Create release manifest
    runs-on: matterlabs-ci-runner
    strategy:
      matrix:
        component:
          - name: server-v2
            platform: linux/amd64
          - name: external-node
            platform: linux/amd64,linux/arm64
          - name: contract-verifier
            platform: linux/amd64
          - name: cross-external-nodes-checker
            platform: linux/amd64
          - name: snapshots-creator
            platform: linux/amd64
    env:
      IMAGE_TAG_SUFFIX: "some-tag"
    steps:
      - name: login to Docker registries
        run: |
          docker login -u ${{ secrets.DOCKERHUB_USER }} -p ${{ secrets.DOCKERHUB_TOKEN }}
          gcloud auth configure-docker us-docker.pkg.dev -q

      - name: Create Docker manifest
        run: |
          docker_repositories=("matterlabs/${{ matrix.component.name }}" "us-docker.pkg.dev/${{ matrix.component.name }}")
          platforms=${{ matrix.component.platform }}
          for repo in "${docker_repositories[@]}"; do
            repo_tags=()
            for platform in ${platforms//,/ }; do
              platform=$(echo $platform | tr '/' '-')
              repo_tags+=(" --amend ${repo}:${IMAGE_TAG_SUFFIX}-${platform} ")
            done
          
            docker manifest create "${repo}:${IMAGE_TAG_SUFFIX}" "${repo_tags[@]}"
          done
