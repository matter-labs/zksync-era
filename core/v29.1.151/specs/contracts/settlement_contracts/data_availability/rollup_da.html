<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rollup DA support - ZKsync Era Documentation</title>


        <!-- Custom HTML head -->
        <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../../css/version-box.css">
        <link rel="stylesheet" href="../../../.././css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync Era Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs/src/specs/contracts/settlement_contracts/data_availability/rollup_da.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rollup-da"><a class="header" href="#rollup-da">Rollup DA</a></h1>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>Before reading this document, it is recommended to understand how the <a href="./custom_da.html">custom DA</a> works in general.</p>
<h2 id="eip-4844-support"><a class="header" href="#eip-4844-support">EIP-4844 Support</a></h2>
<p>EIP-4844, commonly known as Proto-Danksharding, is an upgrade to the Ethereum protocol that introduces a new data availability solution embedded in layer 1. More information about it can be found <a href="https://ethereum.org/en/roadmap/danksharding/">here</a>.</p>
<p>To facilitate EIP-4844 blob support, our circuits allow providing two arrays in our public input to the circuit:</p>
<ul>
<li><code>blobCommitments</code> – the commitment that helps to check the correctness of the blob content. The formula on how it is computed will be explained below in the document.</li>
<li><code>blobHash</code> – the <code>keccak256</code> hash of the inner contents of the blob.</li>
</ul>
<p>Note that our circuits require that each blob contains exactly <code>4096 * 31</code> bytes. The maximal number of blobs that are supported by our proving system is 16, but the system contracts support only 6 blobs at most for now.</p>
<p>When committing a batch, the <code>L1DAValidator</code> is called with the data provided by the operator and it should return the two arrays described above. These arrays are put inside the batch commitment and then the correctness of the commitments will be verified at the proving stage.</p>
<p>Note that the <code>Executor.sol</code> (and the contract itself) is not responsible for checking that the provided <code>blobHash</code> and <code>blobCommitments</code> in any way correspond to the pubdata inside the batch as it is the job of the DA Validation in corresponding contracts on L1 (<code>L1DAValidator</code>) and L2 (<code>L2DAValidator</code> library).</p>
<h2 id="publishing-pubdata-to-l1"><a class="header" href="#publishing-pubdata-to-l1">Publishing pubdata to L1</a></h2>
<p>Let’s see an example of how the approach above works in rollup DA validators.</p>
<h3 id="rollup-use-case-of-l2davalidator-library"><a class="header" href="#rollup-use-case-of-l2davalidator-library">Rollup use case of L2DAValidator library</a></h3>
<p><img src="./img/custom_da.png" alt="RollupUsecaseL2DAValidator.png" /></p>
<p>Let’s consider <code>BLOBS_AND_PUBDATA_KECCAK256</code> commitment scheme. This is the one that’s being used in default <code>RollupL1DAValidator</code>. In this case, the following will happen:</p>
<p><code>L2DAValidator</code> library accepts the preimages for the data to publish as well as their compressed format. After verifying the compression, it forms the <code>_totalPubdata</code> bytes array, which represents the entire blob of data that should be published to L1.</p>
<p>It calls the <code>PubdataChunkPublisher</code> system contract to split this pubdata into multiple “chunks” of size <code>4096 * 31</code> bytes and return the <code>keccak256</code> hash of those, These will be the <code>blobHash</code> of from the section before.</p>
<p>To give the flexibility of checking different DA, we send the following data to L1:</p>
<ul>
<li><code>l2DAValidatorOutputHash</code> that was returned by <code>L2DAValidator</code> library. This hash includes <code>uncompressedStateDiffHash</code>, <code>pubdata</code>, the number of blobs, and <code>blobLinearHashes</code>. This hash, alongside the <code>_operatorDAInput</code> will be provided to <code>L1DAValidator</code> (<code>RollupL1DAValidator.sol</code> is the one that accepts <code>BLOBS_AND_PUBDATA_KECCAK256</code>, for example).</li>
<li><code>_l2DACommitmentScheme</code> that denotes the commitment scheme that was used. In the case we’re looking into, it’s the <code>BLOBS_AND_PUBDATA_KECCAK256</code>.</li>
</ul>
<h3 id="rollupl1davalidator"><a class="header" href="#rollupl1davalidator">RollupL1DAValidator</a></h3>
<p>When committing the batch, the operator will provide the <code>_operatorDAInput</code> and <code>_l2DAValidatorOutputHash</code>. Using these values, <code>RollupL1DAValidator</code> parses the input that the L2 DA validator has provided to it into <code>stateDiffHash</code>, <code>fullPubdataHash</code>, <code>blobsLinearHashes</code>, <code>blobsProvided</code>, <code>l1DaInput</code>. This <code>l1DaInput</code> will be used to prove that the pubdata was indeed provided in this batch.</p>
<p>The first byte of the <code>l1DaInput</code> denotes which way of pubdata publishing was used: calldata or blobs.</p>
<p>In case it is calldata it will be just checked that the provided calldata matches the hash of the <code>fullPubdataHash</code> that was sent by the L2 counterpart. Note that calldata may still contain the blob information as we typically start generating proofs before we know which way of calldata will be used. Note that in case the calldata is used for DA, we do not verify the <code>blobCommitments</code> as the presence of the correct pubdata has been verified already.</p>
<p>In case it is blobs, we need to construct the <code>blobCommitment</code>s correctly for each of the blob of data.</p>
<p>For each of the <code>blob</code>s the operator provides so called <code>_commitment</code> that consists of the following packed structure: <code>opening point (16 bytes) || claimed value (32 bytes) || commitment (48 bytes) || proof (48 bytes)</code>.</p>
<p>The verification of the <code>_commitment</code> can be summarized in the following snippet:</p>
<pre><code class="language-solidity">// The opening point is passed as 16 bytes as that is what our circuits expect and use when verifying the new batch commitment
// PUBDATA_COMMITMENT_SIZE = 144 bytes
pubdata_commitments &lt;- [opening point (16 bytes) || claimed value (32 bytes) || commitment (48 bytes) || proof (48 bytes)] from calldata
opening_point = bytes32(pubdata_commitments[:16])
versioned_hash &lt;- from BLOBHASH opcode

// Given that we needed to pad the opening point for the precompile, append the data after.
point_eval_input = versioned_hash || opening_point || pubdata_commitments[16: PUBDATA_COMMITMENT_SIZE]

// this part handles the following:
// verify versioned_hash == hash(commitment)
// verify P(z) = y
res &lt;- point_valuation_precompile(point_eval_input)

assert uint256(res[32:]) == BLS_MODULUS
</code></pre>
<p>The final <code>blobCommitment</code> is calculated as the hash between the <code>blobVersionedHash</code>, <code>opening point</code> and the <code>claimed value</code>. The zero knowledge circuits will verify that the opening point and the claimed value were calculated correctly and correspond to the data that was hashed under the <code>blobHash</code>.</p>
<h2 id="structure-of-the-pubdata"><a class="header" href="#structure-of-the-pubdata">Structure of the pubdata</a></h2>
<p>Rollups maintain the same structure of pubdata and apply the same rules for compression as those that were used in the previous versions of the system. These can be read <a href="./state_diff_compression_v1_spec.html">here</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../specs/contracts/settlement_contracts/data_availability/custom_da.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../specs/contracts/settlement_contracts/data_availability/standard_pubdata_format.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../specs/contracts/settlement_contracts/data_availability/custom_da.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../specs/contracts/settlement_contracts/data_availability/standard_pubdata_format.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../../../ace.js"></script>
        <script src="../../../../editor.js"></script>
        <script src="../../../../mode-rust.js"></script>
        <script src="../../../../theme-dawn.js"></script>
        <script src="../../../../theme-tomorrow_night.js"></script>

        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../../js/version-box.js"></script>
        <script src="../../../../js/mermaid-init.js"></script>


    </div>
    </body>
</html>
