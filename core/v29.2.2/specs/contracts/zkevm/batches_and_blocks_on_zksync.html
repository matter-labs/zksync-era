<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Batches and blocks on ZKsync - ZKsync Era Documentation</title>


        <!-- Custom HTML head -->
        <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../css/version-box.css">
        <link rel="stylesheet" href="../../.././css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync Era Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs/src/specs/contracts/zkevm/batches_and_blocks_on_zksync.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="batches--l2-blocks-on-zksync"><a class="header" href="#batches--l2-blocks-on-zksync">Batches &amp; L2 blocks on ZKsync</a></h1>
<h2 id="glossary"><a class="header" href="#glossary">Glossary</a></h2>
<ul>
<li><strong>Batch</strong> – a set of transactions that the bootloader processes (<code>commitBatches</code>, <code>proveBatches</code>, and <code>executeBatches</code> work on it). A batch consists of multiple transactions.</li>
<li><strong>L2 blocks</strong> – non-intersecting subsets of consecutively executed transactions in a batch. This is the kind of block you see in the API and the one used for <code>block.number</code>/<code>block.timestamp</code>/etc.</li>
</ul>
<blockquote>
<p>Note that sometimes in code you can see the notion of “virtual blocks.” In the past, we returned batch information for <code>block.number</code>/<code>block.timestamp</code>. However, due to DevEx issues, we decided to move to returning these values for L2 blocks. Virtual blocks were used during migration but are not used anymore. You should consider that there is one virtual block per L2 block and it has exactly the same properties.</p>
</blockquote>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>L2 blocks were created for fast soft confirmation in wallets and block explorers. For example, MetaMask shows transactions as confirmed only after the block in which the transaction execution was mined. So, if the user needs to wait for batch confirmation, it would take at least a few minutes (for soft confirmation) and hours for full confirmation, which is very bad UX. But the API can return soft confirmation much earlier through L2 blocks.</p>
<h2 id="adapting-for-solidity"><a class="header" href="#adapting-for-solidity">Adapting for Solidity</a></h2>
<p>In order to get the returned value for <code>block.number</code>, <code>block.timestamp</code>, <code>blockhash</code>, our compiler used the following functions:</p>
<ul>
<li><code>getBlockNumber</code></li>
<li><code>getBlockTimestamp</code></li>
<li><code>getBlockHashEVM</code></li>
</ul>
<p>These return values for L2 blocks.</p>
<h2 id="blocks-processing-and-consistency-checks"><a class="header" href="#blocks-processing-and-consistency-checks">Blocks’ processing and consistency checks</a></h2>
<p>Our <code>SystemContext</code> contract allows retrieval of information about batches and L2 blocks. Some of the information is hard to calculate on-chain—for instance, time. The timing information (for both batches and L2 blocks) is provided by the operator. To check that the operator provided realistic values, certain checks are done on L1. Generally, though, we try to check as much as we can on L2.</p>
<h3 id="initializing-l1-batch"><a class="header" href="#initializing-l1-batch">Initializing L1 batch</a></h3>
<p>At the start of a batch, the operator <a href="https://github.com/matter-labs/era-contracts/blob/b43cf6b3b069c85aec3cd61d33dd3ae2c462c896/system-contracts/bootloader/bootloader.yul#L3935">provides</a> the batch timestamp, its number, and the hash of the previous batch. The root hash of the Merkle tree serves as the root hash of the batch.</p>
<p>The <code>SystemContext</code> can immediately check whether the provided number is the correct batch number. It also immediately sends the previous batch hash to L1, where it will be checked during the commit operation. Additionally, some general consistency checks are performed. This logic can be found <a href="https://github.com/matter-labs/era-contracts/blob/b43cf6b3b069c85aec3cd61d33dd3ae2c462c896/system-contracts/contracts/SystemContext.sol#L469">here</a>.</p>
<h3 id="l2-blocks-processing-and-consistency-checks"><a class="header" href="#l2-blocks-processing-and-consistency-checks">L2 blocks processing and consistency checks</a></h3>
<h4 id="setl2block"><a class="header" href="#setl2block"><code>setL2Block</code></a></h4>
<p>Before each transaction, we call the <code>setL2Block</code> <a href="https://github.com/matter-labs/era-contracts/blob/b43cf6b3b069c85aec3cd61d33dd3ae2c462c896/system-contracts/bootloader/bootloader.yul#L2884">method</a>. Here, we provide data about the L2 block that the transaction belongs to:</p>
<ul>
<li><code>_l2BlockNumber</code> – the number of the new L2 block.</li>
<li><code>_l2BlockTimestamp</code> – the timestamp of the new L2 block.</li>
<li><code>_expectedPrevL2BlockHash</code> – the expected hash of the previous L2 block.</li>
<li><code>_isFirstInBatch</code> – whether this method is called for the first time in the batch.</li>
<li><code>_maxVirtualBlocksToCreate</code> – the maximum number of virtual blocks to create with this L2 block. This is a legacy field that is always either 0 or 1.</li>
</ul>
<p>If two transactions belong to the same L2 block, only the first one may have a non-zero <code>_maxVirtualBlocksToCreate</code>. The rest of the data must be the same.</p>
<p>The <code>setL2Block</code> <a href="https://github.com/matter-labs/era-contracts/blob/b43cf6b3b069c85aec3cd61d33dd3ae2c462c896/system-contracts/contracts/SystemContext.sol#L355">performs</a> many consistency checks similar to those for the L1 batch.</p>
<h4 id="l2-blockhash-calculation-and-storage"><a class="header" href="#l2-blockhash-calculation-and-storage">L2 blockhash calculation and storage</a></h4>
<p>Unlike the L1 batch’s hash, L2 block hashes can be checked on-chain. The hash of an L2 block is computed as:</p>
<p>The hash of an L2 block is <code>keccak256(abi.encode(_blockNumber, _blockTimestamp, _prevL2BlockHash, _blockTxsRollingHash))</code>. Where <code>_blockTxsRollingHash</code> is defined in the following way:</p>
<ul>
<li><code>_blockTxsRollingHash = 0</code> for an empty block.</li>
<li><code>_blockTxsRollingHash = keccak256(abi.encodePacked(0, tx1_hash))</code> for a block with one transaction.</li>
<li><code>_blockTxsRollingHash = keccak256(abi.encodePacked(keccak256(abi.encodePacked(0, tx1_hash)), tx2_hash))</code> for a block with two transactions, etc.</li>
</ul>
<p>To add a transaction hash to the current miniblock, we use the <code>appendTransactionToCurrentL2Block</code> function of the <code>SystemContext</code> contract.</p>
<p>Since ZKsync is a state-diff-based rollup, there is no way to deduce L2 block hashes based on the transactions in the batch (because there is no access to the transaction hashes). At the same time, to execute the <code>blockhash</code> method, the VM requires knowledge of some previous L2 block hashes. To save on pubdata (by reusing the same storage slots, i.e. only having repeated writes), we <a href="https://github.com/matter-labs/era-contracts/blob/b43cf6b3b069c85aec3cd61d33dd3ae2c462c896/system-contracts/contracts/SystemContext.sol#L73">store</a> only the last 257 block hashes. You can read more about repeated writes and how pubdata is processed <a href="../settlement_contracts/data_availability/standard_pubdata_format.html">here</a>.</p>
<p>We store only the last 257 blocks because the EVM requires only 256 previous hashes, and we use 257 as a safe margin.</p>
<h4 id="legacy-blockhash"><a class="header" href="#legacy-blockhash">Legacy blockhash</a></h4>
<p>For L2 blocks that were created before we switched to the formulas above, we use the following formula for their hash:</p>
<p><code>keccak256(abi.encodePacked(uint32(_blockNumber)))</code></p>
<p>These are only very old blocks on ZKsync Era; other ZK chains do not have such blocks.</p>
<h4 id="timing-invariants"><a class="header" href="#timing-invariants">Timing invariants</a></h4>
<p>While the timestamp of each L2 block is provided by the operator, the system preserves these timing invariants:</p>
<ul>
<li>For each L2 block, its timestamp should be greater than the timestamp of the previous L2 block.</li>
<li>For each L2 block, its timestamp should be ≥ the timestamp of the batch it belongs to.</li>
<li>Each batch must start with a new L2 block (i.e. an L2 block cannot span across batches).</li>
<li>The timestamp of a batch must be ≥ the timestamp of the latest L2 block from the previous batch.</li>
<li>The timestamp of the last miniblock in a batch cannot go too far into the future. This is enforced by publishing an L2→L1 log with the timestamp, which is then checked on L1.</li>
</ul>
<h3 id="fictive-l2-block--finalizing-the-batch"><a class="header" href="#fictive-l2-block--finalizing-the-batch">Fictive L2 block &amp; finalizing the batch</a></h3>
<p>At the end of a batch, the bootloader calls <code>setL2Block</code> <a href="https://github.com/matter-labs/era-contracts/blob/b43cf6b3b069c85aec3cd61d33dd3ae2c462c896/system-contracts/bootloader/bootloader.yul#L4110">one more time</a> to allow the operator to create a new empty block. This is done for technical reasons inside the node, where each batch ends with an empty L2 block.</p>
<p>We do not enforce that the last block is empty explicitly, as that complicates development and testing. In practice, it is empty, and either way, the system remains secure.</p>
<p>Also, at the end of a batch, we send both the batch timestamp and the timestamp of the last miniblock so that L1 can verify those two values are realistic. Checking any other L2 block’s timestamp is not required since all of them are enforced to lie between those two.</p>
<h2 id="additional-note-on-blockhashes"><a class="header" href="#additional-note-on-blockhashes">Additional note on blockhashes</a></h2>
<p>In the past, we had to apply different formulas based on whether the migration from batch environment info to L2 block info had finished. You can find these checks <a href="https://github.com/matter-labs/era-contracts/blob/b43cf6b3b069c85aec3cd61d33dd3ae2c462c896/system-contracts/contracts/SystemContext.sol#L137">here</a>. But note that the migration ended quite some time ago, so only two cases remain:</p>
<ul>
<li>When the block is out of the readable range.</li>
<li>When it is a normal L2 block, and its hash must be used.</li>
</ul>
<p>The only edge case is when we ask for a miniblock block number for which the base hash is returned. This edge case will be removed in future releases.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../specs/contracts/zkevm/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../specs/contracts/zkevm/bootloader.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../specs/contracts/zkevm/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../specs/contracts/zkevm/bootloader.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../../ace.js"></script>
        <script src="../../../editor.js"></script>
        <script src="../../../mode-rust.js"></script>
        <script src="../../../theme-dawn.js"></script>
        <script src="../../../theme-tomorrow_night.js"></script>

        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../js/version-box.js"></script>
        <script src="../../../js/mermaid-init.js"></script>


    </div>
    </body>
</html>
