<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Transactions - ZKsync Era Documentation</title>


        <!-- Custom HTML head -->
        <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../css/version-box.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync Era Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs/src/guides/advanced/06_how_transaction_works.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="life-of-transaction"><a class="header" href="#life-of-transaction">Life of transaction</a></h1>
<p>In this article, we will explore the lifecycle of a transaction, which is an operation that is stored permanently in the
blockchain and results in a change of its overall state.</p>
<p>To better understand the content discussed here, it is recommended that you first read the <a href="how_call_works.html" title="life of call">life of a
call</a>.</p>
<h2 id="l1-vs-l2-transactions"><a class="header" href="#l1-vs-l2-transactions">L1 vs L2 transactions</a></h2>
<p>There are two main methods through which transactions can enter the system. The most common approach involves making a
call to the RPC (Remote Procedure Call), where you send what is known as an <a href="https://github.com/matter-labs/zksync-era/blob/main/core/lib/types/src/l2/mod.rs#L140" title="l2 tx"><code>L2Tx</code></a> transaction.</p>
<p>The second method involves interacting with Ethereum directly by sending a ‘wrapped’ transaction to our Ethereum
contract. These transactions are referred to as <a href="https://github.com/matter-labs/zksync-era/blob/main/core/lib/types/src/l1/mod.rs#L183" title="l1 tx"><code>L1Tx</code></a> or Priority transactions, and the process of sending
transactions in this manner is called the ‘priority queue’.</p>
<h3 id="transaction-types"><a class="header" href="#transaction-types">Transaction types</a></h3>
<p>We provide support for five different types of transactions.</p>
<p>Here’s a simplified table of the transaction types:</p>
<div class="table-wrapper"><table><thead><tr><th>Type id</th><th>Transaction type</th><th>Features</th><th>Use cases</th><th>% of transactions (mainnet/testnet)</th></tr></thead><tbody>
<tr><td>0x0</td><td>‘Legacy’</td><td>Only includes <code>gas price</code></td><td>These are traditional Ethereum transactions.</td><td>60% / 82%</td></tr>
<tr><td>0x1</td><td>EIP-2930</td><td>Contains a list of storage keys/addresses the transaction will access</td><td>At present, this type of transaction is not enabled.</td><td></td></tr>
<tr><td>0x2</td><td>EIP-1559</td><td>Includes <code>max_priority_fee_per_gas</code>, <code>max_gas_price</code></td><td>These are Ethereum transactions that provide more control over the gas fee.</td><td>35% / 12%</td></tr>
<tr><td>0x71</td><td>EIP-712 (specific to ZKsync)</td><td>Similar to EIP-1559, but also adds <code>max_gas_per_pubdata</code>, custom signatures, and Paymaster support</td><td>This is used by those who are using ZKsync specific Software Development Kits (SDKs).</td><td>1% / 2%</td></tr>
<tr><td>0xFF</td><td>L1 transactions also known as priority transactions <code>L1Tx</code></td><td>Originating from L1, these have more custom fields like ‘refund’ addresses etc</td><td>Mainly used to transfer funds/data between L1 &amp; L2 layer.</td><td>4% / 3%</td></tr>
</tbody></table>
</div>
<p>Here’s the code that does the parsing: <a href="https://github.com/matter-labs/zksync-era/blob/main/core/lib/types/src/transaction_request.rs#L196" title="transaction request from bytes">TransactionRequest::from_bytes</a></p>
<h2 id="transactions-lifecycle"><a class="header" href="#transactions-lifecycle">Transactions lifecycle</a></h2>
<h3 id="priority-queue-l1-tx-only"><a class="header" href="#priority-queue-l1-tx-only">Priority queue (L1 Tx only)</a></h3>
<p>L1 transactions are first ‘packaged’ and then sent to our Ethereum contract. After this, the L1 contract records this
transaction in L1 logs. <a href="https://github.com/matter-labs/zksync-era/blob/main/core/node/eth_watch" title="Ethereum watcher component">The <code>eth_watcher</code> component</a> constantly monitors these logs and then adds them to
the database (mempool).</p>
<h3 id="rpc--validation-l2-tx-only"><a class="header" href="#rpc--validation-l2-tx-only">RPC &amp; validation (L2 Tx only)</a></h3>
<p>Transactions are received via the <code>eth_sendRawTransaction</code> method. These are then parsed and validated using the
<a href="https://github.com/matter-labs/zksync-era/blob/main/core/lib/zksync_core/src/api_server/tx_sender/mod.rs#L288" title="submit tx"><code>submit_tx</code></a> method on the API server.</p>
<p>The validations ensure that the correct amount of gas has been assigned by the user and that the user’s account has
sufficient gas, among other things.</p>
<p>As part of this validation, we also perform a <code>validation_check</code> to ensure that if account abstraction / paymaster is
used, they are prepared to cover the fees. Additionally, we perform a ‘dry_run’ of the transaction for a better
developer experience, providing almost immediate feedback if the transaction fails.</p>
<p>Please note, that transaction can still fail in the later phases, even if it succeeded in the API, as it is going to be
executed in the context of a different block.</p>
<p>Once validated, the transaction is added to the mempool for later execution. Currently, the mempool is stored in the
<code>transactions</code> table in postgres (see the <code>insert_transaction_l2()</code> method).</p>
<h3 id="batch-executor--state-keeper"><a class="header" href="#batch-executor--state-keeper">Batch executor &amp; State keeper</a></h3>
<p>The State Keeper’s job is to take transactions from the mempool and place them into an L1 batch. This is done using the
<a href="https://github.com/matter-labs/zksync-era/blob/main/core/lib/zksync_core/src/state_keeper/keeper.rs#L257" title="process l1 batch"><code>process_l1_batch()</code></a> method.</p>
<p>This method takes the next transaction from the mempool (which could be either an L1Tx or L2Tx - but L1Tx are always
given the priority and they are taken first), executes it, and checks if the L1 batch is ready to be sealed (for more
details on when we finalize L1 batches, see the ‘Blocks &amp; Batches’ article).</p>
<p>Once the batch is sealed, it’s ready to be sent for proof generation and have this proof committed into L1. More details
on this will be covered in a separate article.</p>
<p>The transaction can have three different results in state keeper:</p>
<ul>
<li>Success</li>
<li>Failure (but still included in the block, and gas was charged)</li>
<li>Rejection - when it fails validation, and cannot be included in the block. This last case should (in theory) never
happen - as we cannot charge the fee in such scenario, and it opens the possibility for the DDoS attack.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../guides/advanced/05_how_call_works.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../guides/advanced/07_fee_model.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../guides/advanced/05_how_call_works.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../guides/advanced/07_fee_model.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../js/version-box.js"></script>
        <script src="../../js/mermaid-init.js"></script>


    </div>
    </body>
</html>
