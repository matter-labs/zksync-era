<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Configuration Format Changes - ZKsync Era Documentation</title>


        <!-- Custom HTML head -->
        <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../css/version-box.css">
        <link rel="stylesheet" href=".././css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync Era Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs/src/announcements/config_format_changes.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="configuration-format-changes"><a class="header" href="#configuration-format-changes">Configuration Format Changes</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>As of April 2025, ZKsync nodes are transitioning to
<a href="https://github.com/matter-labs/smart-config">the new multi-layered configuration system</a> developed in-house as a Rust
library (usable for other apps as well!).</p>
<p>The reasons for this transition are multifold; the main ones include:</p>
<ul>
<li>Flexible distribution of configuration sources. Currently, node support either loading configuration <em>only</em> from env
variables, or from a predefined set of YAML files, each with a fixed schema. With the new system, it will be possible
to arbitrarily distribute params among YAML / JSON files, and/or env variables. Redefinitions will be resolved via
well-defined source priorities.</li>
<li>Unification of parameter naming / schema for env-based and file-based config sources. Currently, some params have a
differing name and/or schema depending on the source.</li>
<li>Reasonable defaults for the majority of config parameters. Currently, the vast majority of parameters are required.</li>
<li>Auto-generated documentation for config params embedded directly into the node executable.</li>
</ul>
<p>There are more; see the
<a href="https://github.com/matter-labs/smart-config/tree/main/crates/smart-config#readme">config system readme</a> for a more
complete list of features.</p>
<h2 id="migration-path"><a class="header" href="#migration-path">Migration path</a></h2>
<p>Migration to the new system will proceed in stages. On the initial stage, the node CLI options related to the config
will not change (i.e., a node will still read the config either from env vars, or from a list of YAML files). The vast
majority of the config schema is backward-compatible, both for file-based and env-based formats, with a couple of
exceptions described below.</p>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="#admonition-warning"></a>
</div>
<div>
<p>The env-based format is <em>de facto</em> currently deprecated for the main node (the <code>zksync_server</code> binary; launched via <code>zkstack server</code>).
Potential breaking changes in it are not exhaustively tested and will be fixed at best-effort basis.</p>
</div>
</div>
<p>The initial stage will also not touch env-based config for non-validator / external nodes (<code>zksync_external_node</code>
binary); it will be migrated separately.</p>
<p>Migration is only necessary for <em>existing</em> configurations; config files newly created via (updated) <code>zkstack</code> will have
the necessary changes applied automatically.</p>
<h3 id="tagged-enumerations"><a class="header" href="#tagged-enumerations">Tagged enumerations</a></h3>
<p>The current schema uses “one-of” encoding for enumerations, in which an enumeration is represented as a single-field
object with the key corresponding to the variant, and value being the variant payload. With the change, the tagged
representation will be used instead, in which the tag is placed in a separate key <em>adjacent</em> to the payload. (Tagged
representation works better with prioritized merging.)</p>
<p>All of tagged enumeration migrations other than the <code>da_client.eigen.points_source_(url|path)</code> (described in details
below) are not technically required; a node should pick up the existing “one-of” encoding. Still, these migrations are
strongly recommended for better forward compatibility.</p>
<p>The following enumeration configs are affected.</p>
<h4 id="object-stores"><a class="header" href="#object-stores">Object stores</a></h4>
<p>Object store configs at <code>snapshot_creator.object_store</code>, <code>prover.prover_object_store</code>, <code>snapshot_recovery.object_store</code>,
and <code>core_object_store</code> in <code>general.yaml</code>.</p>
<p>As an example, take the following configuration before migration:</p>
<pre><code class="language-yaml">core_object_store:
  file_backed:
    file_backed_base_path: artifacts
  max_retries: 10
</code></pre>
<p>In the new format, it will look as follows:</p>
<pre><code class="language-yaml">core_object_store:
  mode: FileBacked
  file_backed_base_path: artifacts
  max_retries: 10
</code></pre>
<p>I.e., the object beneath the <code>file_backed</code> tag is unindented, and the tag itself is transformed to <code>mode: FileBacked</code>.
It is possible to define a config that will be parsed both by old and new node versions; this is recommended for
no-downtime migration.</p>
<pre><code class="language-yaml">core_object_store:
  # Read by old node versions
  file_backed:
    file_backed_base_path: artifacts
  # Read by new node versions
  mode: FileBacked
  file_backed_base_path: artifacts
  # Read by both
  max_retries: 10
</code></pre>
<h4 id="da-client"><a class="header" href="#da-client">DA client</a></h4>
<p>DA client configs at <code>da_client</code> in <code>general.yaml</code> and at <code>da</code> in <code>secrets.yaml</code>. Additionally, some clients have
additional enumerations:</p>
<ul>
<li>If the Avail DA client is configured, <code>da_client.avail</code> specifies the client subtype: <code>full_client</code> or <code>gas_relay</code>.</li>
<li>If the Eigen DA client is configured, <code>da_client.eigen</code> specifies the EC points source: <code>points_source_url</code> or
<code>points_source_path</code>.</li>
</ul>
<p>As an example, take the following fragment of <code>general.yaml</code> before migration:</p>
<pre><code class="language-yaml">da_client:
  avail:
    bridge_api_url: https://turing-bridge-api.avail.so/
    timeout_ms: 10000
    gas_relay:
      gas_relay_api_url: https://example.com/
      max_retries: 7
</code></pre>
<p>In the new format, 2 enumerations will be changed: one at <code>da_client</code> (acquiring tag <code>client</code>) and at
<code>da_client.avail.gas_relay</code> (acquiring tag <code>avail_client_type</code>):</p>
<pre><code class="language-yaml">da_client:
  bridge_api_url: https://turing-bridge-api.avail.so/
  timeout_ms: 10000
  avail_client_type: GasRelay
  gas_relay_api_url: https://example.com/
  max_retries: 7
  client: Avail
</code></pre>
<p>As in the previous case, it is possible to define a config that will be parsed both by old and new node versions by
deep-merging the old and new configs.</p>
<p>An example for the Eigen DA client:</p>
<pre><code class="language-yaml"># Before migration
da_client:
  eigen:
    disperser_rpc: https://disperser-holesky.eigenda.xyz:443
    settlement_layer_confirmation_depth: 0
    eigenda_eth_rpc: https://holesky.infura.io/v3/CORRECT_HORSE
    eigenda_svc_manager_address: 0xD4A7E1Bd8015057293f0D0A557088c286942e84b
    wait_for_finalization: true
    authenticated: true
    points_source_url:
      g1_url: https://raw.githubusercontent.com/lambdaclass/zksync-eigenda-tools/6944c9b09ae819167ee9012ca82866b9c792d8a1/resources/g1.point
      g2_url: https://raw.githubusercontent.com/lambdaclass/zksync-eigenda-tools/6944c9b09ae819167ee9012ca82866b9c792d8a1/resources/g2.point.powerOf2
---
# After migration
da_client:
  client: Eigen
  disperser_rpc: https://disperser-holesky.eigenda.xyz:443
  settlement_layer_confirmation_depth: 0
  eigenda_eth_rpc: https://holesky.infura.io/v3/CORRECT_HORSE
  eigenda_svc_manager_address: 0xD4A7E1Bd8015057293f0D0A557088c286942e84b
  wait_for_finalization: true
  authenticated: true
  points:
    source: Url
    g1_url: https://raw.githubusercontent.com/lambdaclass/zksync-eigenda-tools/6944c9b09ae819167ee9012ca82866b9c792d8a1/resources/g1.point
    g2_url: https://raw.githubusercontent.com/lambdaclass/zksync-eigenda-tools/6944c9b09ae819167ee9012ca82866b9c792d8a1/resources/g2.point.powerOf2
</code></pre>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note"></a>
</div>
<div>
<p><code>da_client.eigen.points_source_(url|path)</code> <strong>MUST</strong> be transformed, unlike other enumations mentioned in the section.
This is caused by inconsistency between the logical structure of the corresponding config and its serialization schema,
which has been fixed in the new schema.</p>
</div>
</div>
<p>For <code>secrets.yaml</code>, the change is as follows:</p>
<pre><code class="language-yaml"># Before migration
da:
  avail:
    seed_phrase: correct horse battery staple
---
# After migration
da:
  client: Avail
  seed_phrase: correct horse battery staple
</code></pre>
<p>It is recommended (although not strictly necessary) to also rename <code>da</code> in <code>secrets.yaml</code> to <code>da_client</code> (or copy if
no-downtime migration is required).</p>
<h4 id="deployment-allowlist"><a class="header" href="#deployment-allowlist">Deployment allowlist</a></h4>
<p>Configuration at <code>state_keeper.deployment_allowlist</code>. The tag field name in this case is <code>source</code>:</p>
<pre><code class="language-yaml"># Before migration
state_keeper:
  deployment_allowlist:
    dynamic:
      http_file_url: http://deployment_allowlist/
      refresh_interval_secs: 60
---
# After migration
state_keeper:
  deployment_allowlist:
    source: Dynamic
    http_file_url: http://deployment_allowlist/
    refresh_interval_secs: 60
</code></pre>
<h3 id="other-changes"><a class="header" href="#other-changes">Other changes</a></h3>
<ul>
<li><code>snapshot_recovery.experimental.drop_storage_key_preimages</code> parameter, if present, should be moved / copied to
<code>snapshot_recovery.drop_storage_key_preimages</code>.</li>
<li>Likewise, <code>snapshot_recovery.experimental.tree_recovery_parallel_persistence_buffer</code>, if present, should be moved /
copied to <code>snapshot_recovery.tree.parallel_persistence_buffer</code>.</li>
</ul>
<h2 id="debugging-configuration"><a class="header" href="#debugging-configuration">Debugging configuration</a></h2>
<p>To debug configuration parameters, launch the node with the <code>config</code> command, e.g. <code>zksync_server config</code> or
<code>zkstack server -- config</code> if using <code>zkstack</code>. By default, the <code>config</code> command will output help on configuration
params, optionally filtered by the param name. If the <code>--debug</code> flag is specified, param values will be output instead.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../announcements/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../announcements/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../js/version-box.js"></script>
        <script src="../js/mermaid-init.js"></script>


    </div>
    </body>
</html>
