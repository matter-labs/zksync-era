<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Priority queue - ZKsync Era Documentation</title>


        <!-- Custom HTML head -->
        <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../../css/version-box.css">
        <link rel="stylesheet" href="../../../.././css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync Era Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-era/tree/main/docs/src/specs/contracts/settlement_contracts/priority_queue/priority-queue.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="priority-queue-to-merkle-tree"><a class="header" href="#priority-queue-to-merkle-tree">Priority Queue to Merkle Tree</a></h1>
<h2 id="overview-of-the-current-implementation"><a class="header" href="#overview-of-the-current-implementation">Overview of the current implementation</a></h2>
<p>Priority queue is a data structure in Era contracts that is used to handle L1-&gt;L2 priority operations. It supports the following:</p>
<ul>
<li>inserting a new operation into the end of the queue</li>
<li>checking that an newly executed batch executed some n first priority operations from the queue (and not some other ones) in correct order</li>
</ul>
<p>The queue itself only stores the following:</p>
<pre><code class="language-solidity">struct PriorityOperation {
  bytes32 canonicalTxHash;
  uint64 expirationTimestamp;
  uint192 layer2Tip;
}
</code></pre>
<p>of which we only care about the canonical hash.</p>
<h3 id="inserting-new-operations"><a class="header" href="#inserting-new-operations">Inserting new operations</a></h3>
<p>The queue is implemented as a <a href="https://github.com/matter-labs/era-contracts/blob/b43cf6b3b069c85aec3cd61d33dd3ae2c462c896/l1-contracts/contracts/state-transition/libraries/PriorityQueue.sol#L22">library</a>.
For each incoming priority operation, we simply <code>pushBack</code> its hash, expiration and layer2Tip.</p>
<h3 id="checking-validity"><a class="header" href="#checking-validity">Checking validity</a></h3>
<p>When a new batch is executed, we need to check that operations that were executed there match the operations in the priority queue. The batch header contains <code>numberOfLayer1Txs</code> and <code>priorityOperationsHash</code> which is a rolling hash of all priority operations that were executed in the batch. Bootloader check that this hash indeed corresponds to all priority operations that have been executed in that batch. The contract only checks that this hash matches the operations stored in the queue:</p>
<pre><code class="language-solidity">/// @dev Pops the priority operations from the priority queue and returns a rolling hash of operations
function _collectOperationsFromPriorityQueue(uint256 _nPriorityOps) internal returns (bytes32 concatHash) {
    concatHash = EMPTY_STRING_KECCAK;

    for (uint256 i = 0; i &lt; _nPriorityOps; i = i.uncheckedInc()) {
        PriorityOperation memory priorityOp = s.priorityQueue.popFront();
        concatHash = keccak256(abi.encode(concatHash, priorityOp.canonicalTxHash));
    }
}

bytes32 priorityOperationsHash = _collectOperationsFromPriorityQueue(_storedBatch.numberOfLayer1Txs);
require(priorityOperationsHash == _storedBatch.priorityOperationsHash); // priority operations hash does not match to expected
</code></pre>
<p>As can be seen, this is done in <code>O(n)</code> compute, where <code>n</code> is the number of priority operations in the batch.</p>
<h2 id="motivation-for-migration-to-merkle-tree"><a class="header" href="#motivation-for-migration-to-merkle-tree">Motivation for migration to Merkle Tree</a></h2>
<p>Since we will be introducing Gateway, we will need to support one more operation:</p>
<ul>
<li>migrating priority queue from L1 to Gateway (and back)</li>
</ul>
<p>Current implementation takes <code>O(n)</code> space and is vulnerable to spam attacks during migration
(e.g. an attacker can insert a lot of priority operations and we won’t be able to migrate all of them due to gas limits).</p>
<p>Hence, we need an implementation with a small (constant- or log-size) space imprint that we can migrate to Gateway and back that would still allow us to perform the other 2 operations.</p>
<p>Merkle tree of priority operations is perfect for this since we can simply migrate the latest root hash to Gateway and back.</p>
<ul>
<li>It can still efficiently (in <code>O(height)</code>) insert new operations.</li>
<li>It can also still efficiently (in <code>O(n)</code> compute and <code>O(n + height)</code> calldata) check that the batch’s <code>priorityOperationsHash</code> corresponds to the operations from the queue.</li>
</ul>
<p>Note that <code>n</code> here is the number of priority operations in the batch, not <code>2^height</code>.</p>
<p>The implementation details are described below.</p>
<h3 id="faq"><a class="header" href="#faq">FAQ</a></h3>
<ul>
<li>Q: Why can’t we just migrate the rolling hash of the operations in the existing priority queue?</li>
<li>A: The rolling hash is not enough to check that the operations from the executed batch are indeed from the priority queue. We would need to store all historical rolling hashes, which would be <code>O(n)</code> space and would not solve the spam attack problem.</li>
</ul>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>The implementation will consist of two parts:</p>
<ul>
<li>Merkle tree on L1 contracts, to replace the existing priority queue (while still supporting the existing operations)</li>
<li>Merkle tree off-chain on the server, to generate the merkle proofs for the executed priority operations.</li>
</ul>
<h3 id="contracts"><a class="header" href="#contracts">Contracts</a></h3>
<p>On the contracts, the Merkle tree will be implemented as an Incremental (append-only) Merkle Tree (<a href="https://github.com/tornadocash/tornado-core/blob/master/contracts/MerkleTreeWithHistory.sol">example implementation</a>), meaning that it can efficiently (in <code>O(height)</code> compute) append new elements to the right, while only storing <code>O(height)</code> nodes at all times.</p>
<p>It will also be dynamically sized, meaning that it will double in size when the current size is not enough to store the new element.</p>
<h3 id="server"><a class="header" href="#server">Server</a></h3>
<p>On the server, the Merkle tree will be implemented as an extension of <code>MiniMerkleTree</code> currently used for L2-&gt;L1 logs.</p>
<p>It will have the following properties:</p>
<ul>
<li>in-memory: the tree will be stored in memory and will be rebuilt on each restart (details below).</li>
<li>dynamically sized (to match the contracts implementation)</li>
<li>append-only (to match the contracts implementation)</li>
</ul>
<p>The tree does not need to be super efficient, since we process on average 7 operations per batch.</p>
<h3 id="why-in-memory"><a class="header" href="#why-in-memory">Why in-memory?</a></h3>
<p>Having the tree in-memory means rebuilding the tree on each restart. This is fine because on mainnet after &gt;1 year since release we have only 3.2M priority operations. We only have to fully rebuild the tree <em>once</em> and then simply cache the already executed operations (which are the majority). Having the tree in-memory has an added benefit of not having to have additional infrastructure to store it on disk and not having to be bothered to rollback its state manually if we ever have to (as we do for e.g. for the storage logs tree).</p>
<p>Note: If even rebuilding it once becomes a problem, it can be easily mitigated by only persisting the cache nodes.</p>
<h3 id="caching"><a class="header" href="#caching">Caching</a></h3>
<p><strong>Why do we need caching?</strong> After a batch is successfully executed, we will no longer need to have the ability to generate merkle paths for those operations. This means that we can save space and compute by only fully storing the operations that are not yet executed, and caching the leaves
corresponding to the already executed operations.</p>
<p>We will only cache some prefix of the tree, meaning nodes in the interval [0; N) where N is the number of executed priority operations. The cache will store the rightmost cached left-child node on each level of the tree (see diagrams).</p>
<p><img src="./img/PQ1.png" alt="Untitled" /></p>
<p><img src="./img/PQ2.png" alt="Untitled" /></p>
<p><img src="./img/PQ3.png" alt="Untitled" /></p>
<p>This means that we will not be able to generate merkle proofs for the cached nodes (and since they are already executed, we don’t need to). This structure allows us to save a lot of space, since it only takes up <code>O(height)</code> space instead of linear space for all executed operations. This is a big optimization since there are currently 3.2M total operations but &lt;10 non-executed operations in the mainnet priority queue, which means most of the tree will be cached.</p>
<p>This also means we don’t really have to store non-leaf nodes other than cache, since we can calculate merkle root / merkle paths in <code>O(n)</code> where <code>n</code> is the number of non-executed operations (and not total number of operations), and since <code>n</code> is so small, it is really fast.</p>
<h3 id="adding-new-operations"><a class="header" href="#adding-new-operations">Adding new operations</a></h3>
<p>On the contracts, appending a new operation to the tree is done by simply calling <code>append</code> on the Incremental Merkle Tree, which will update at most <code>height</code> slots. Actually, it works almost exactly like the cache described above. Once again: <a href="https://github.com/tornadocash/tornado-core/blob/1ef6a263ac6a0e476d063fcb269a9df65a1bd56a/contracts/MerkleTreeWithHistory.sol#L68">tornado-cash implementation</a>.</p>
<p>On the server, <code>eth_watch</code> will listen for <code>NewPriorityOperation</code> events as it does now, and will append the new operation to the tree on the server.</p>
<h3 id="checking-validity-1"><a class="header" href="#checking-validity-1">Checking validity</a></h3>
<p>To check that the executed batch indeed took its priority operations from the queue, we have to make sure that if we take first <code>numberOfL1Txs</code> non-executed operations from the tree, their rolling hash will match <code>priorityOperationsHash</code> . Since will not be storing the hashes of these operations onchain anymore, we will have to provide them as calldata. Additionally in calldata, we should provide merkle proofs for the <strong>first and last</strong> operations in that batch (hence <code>O(n + height)</code> calldata). This will make it possible to prove onchain that that contiguous interval of hashes indeed exists in the merkle tree.</p>
<p>This can be done simply by constructing the part of the tree above this interval using the provided paths to first and last elements of the interval checking that computed merkle root matches with stored one (in <code>O(n)</code> where <code>n</code> is number of priority operations in a batch). We will also need to track the <code>index</code> of the first unexecuted operation onchain to properly calculate the merkle root and ensure that batches don’t execute some operations out of order or multiple times.</p>
<p>We will also need to prove that the rolling hash of provided hashes matches with <code>priorityOperationsHash</code> which is also <code>O(n)</code></p>
<p>It is important to note that we should store some number of historical root hashes, since the Merkle tree on the server might lag behind the contracts a bit, and hence merkle paths generated on the server-side might become invalid if we compare them to the latest root hash on the contracts. These historical root hashes are not necessary to migrate to and from Gateway though.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../specs/contracts/settlement_contracts/priority_queue/l1_l2_communication/overview_deposits_withdrawals.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../specs/prover/overview.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../specs/contracts/settlement_contracts/priority_queue/l1_l2_communication/overview_deposits_withdrawals.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../specs/prover/overview.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../../../ace.js"></script>
        <script src="../../../../editor.js"></script>
        <script src="../../../../mode-rust.js"></script>
        <script src="../../../../theme-dawn.js"></script>
        <script src="../../../../theme-tomorrow_night.js"></script>

        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../../js/version-box.js"></script>
        <script src="../../../../js/mermaid-init.js"></script>


    </div>
    </body>
</html>
